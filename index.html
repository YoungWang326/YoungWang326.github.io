<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>日期笔记日历</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
    background: linear-gradient(180deg, #f8fafc, #eef2ff);
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 16px 24px;
    background: #ffffff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }

  .controls input,
  .controls button {
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 6px;
    border: 1px solid #c7d2fe;
  }

  .controls button {
    background: #6366f1;
    color: white;
    border: none;
    cursor: pointer;
  }

  .controls button.export {
    background: #16a34a;
  }

  main {
    flex: 1;
    padding: 16px;
    overflow: auto;
  }

  .calendar {
    min-height: 100%;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 12px;
  }

  .day {
    background: #ffffff;
    border-radius: 12px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    cursor: pointer;
  }

  /* 高亮（通用） */
  .day.highlight {
    border: 2px solid #6366f1;
    background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
  }

  /* 周末基础 */
  .day.weekend {
    background: #fff7ed;
  }

  /* 周末高亮 */
  .day.weekend.highlight {
    border-color: #fb923c;
    background: linear-gradient(135deg, #ffedd5, #fed7aa);
  }

  .day-header {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    margin-bottom: 6px;
  }

  .weekday { color: #6366f1; }
  .weekend .weekday { color: #ea580c; }

  .note {
    font-size: 13px;
    white-space: pre-wrap;
    word-break: break-word;
    flex: 1;
  }

  .empty {
    color: #9ca3af;
    font-style: italic;
  }
</style>
</head>

<body>

<header>
  <div class="controls">
    <label>开始日期：
      <input type="date" id="startDate">
    </label>
    <label>结束日期：
      <input type="date" id="endDate">
    </label>
    <button onclick="generateCalendar()">生成日历</button>
    <button class="export" onclick="exportImage()">导出为图片</button>
  </div>
</header>

<main>
  <div id="calendar" class="calendar"></div>
</main>

<script>
  const STORAGE_KEY = "calendarNotesV1";

  let state = {
    startDate: "",
    endDate: "",
    days: {
      /*
        "2025-01-01": {
          note: "内容",
          highlight: true
        }
      */
    }
  };

  const weekdays = ["星期日","星期一","星期二","星期三","星期四","星期五","星期六"];

  /* ---------- 本地存储 ---------- */
  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function loadState() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      state = JSON.parse(saved);
      startDate.value = state.startDate;
      endDate.value = state.endDate;
      if (state.startDate && state.endDate) {
        generateCalendar();
      }
    }
  }

  /* ---------- 日历生成 ---------- */
  function generateCalendar() {
    state.startDate = startDate.value;
    state.endDate = endDate.value;
    saveState();

    const start = new Date(state.startDate);
    const end = new Date(state.endDate);
    if (start > end) return alert("开始日期不能大于结束日期");

    calendar.innerHTML = "";
    let current = new Date(start);

    while (current <= end) {
      const dateStr = current.toISOString().split("T")[0];
      const dayIndex = current.getDay();
      const isWeekend = dayIndex === 0 || dayIndex === 6;
      const dayState = state.days[dateStr] || {};

      const box = document.createElement("div");
      box.className = "day";
      if (isWeekend) box.classList.add("weekend");
      if (dayState.highlight) box.classList.add("highlight");

      const header = document.createElement("div");
      header.className = "day-header";
      header.innerHTML = `
        <div>${dateStr}</div>
        <div class="weekday">${weekdays[dayIndex]}</div>
      `;

      const note = document.createElement("div");
      note.className = "note";

      if (dayState.note) {
        note.textContent = dayState.note;
      } else {
        note.textContent = "点击添加笔记";
        note.classList.add("empty");
      }

      box.append(header, note);

      box.onclick = () => editDay(dateStr, isWeekend);

      calendar.appendChild(box);
      current.setDate(current.getDate() + 1);
    }
  }

  /* ---------- 编辑 ---------- */
  function editDay(dateStr, isWeekend) {
    const existing = state.days[dateStr] || {};
    const noteText = prompt("请输入当天笔记：", existing.note || "");
    if (noteText === null) return;

    if (!noteText.trim()) {
      delete state.days[dateStr];
      saveState();
      generateCalendar();
      return;
    }

    const highlight = confirm("是否高亮当天？");

    state.days[dateStr] = {
      note: noteText,
      highlight
    };

    saveState();
    generateCalendar();
  }

  /* ---------- 导出 ---------- */
  function exportImage() {
    html2canvas(calendar, {
      backgroundColor: "#f8fafc",
      scale: 2
    }).then(canvas => {
      const link = document.createElement("a");
      link.download = "日历笔记.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  }

  loadState();
</script>

</body>
</html>
